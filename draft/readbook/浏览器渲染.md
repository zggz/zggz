---
title: 浏览器渲染
date: 2020-11-25 18:14:05
tags: JavaScript
---

## Introduction

主要描述浏览器的渲染	


## 一个页面页面进程
1. 浏览器进程
	- 界面显示、用户交互、子进程管理
2. 渲染进程
	- 核心将html、css、JavaScript转换成用户可以交互的网页
	-  排版引擎blink
	- JavaScript引擎V8
3. GPU进程
	- 最初实现CSS3效果
	- 最后chrome的UI和网页都是采用GPU来绘制
4. 网络进程
	- 主要负责网络资源加载
5. 插件进程
	- 插件的运行隔离

<!-- more -->

## 导航流程

（用户发出URL请求到页面开始解析的过程，叫做导航）

## URL请求过程

## 浏览器进程

### 用户输入
- 如果是搜索内容，会使用搜索引搜索
- 如果是URL，会根据URL规范合成完整的协议

### 网络进程
- 浏览器进程通过  （IPC）将请求交给网络进程
- 网络进程首先会检查本地储存 
-  进入网络请求流程
	- DNS解析
		- 获取IP
		- 如果是https请求，还需要 建立TLS
	- 收到响应头和响应行，就开始解析响应头的内容
	- 如果响应状态码是301、302
	- 从响应头的 Location 字段里面读取重定向的地址
	- 响应数据类型处理
	- 浏览器根据content-type来决定如何显示响应内容

### 渲染进程
1. 打开一个新页面采用的渲染进程策略就是：通常情况下，打开新的页面都会使用单独的渲染进程；
2. 如果从 A 页面打开 B 页面，且 A 和 B 都属于同一站点的话，那么 B 页面复用 A 页面的渲染进程；
3. 如果是其他情况，浏览器进程则会为 B 创建一个新的渲染进程。

	```sh
		# 渲染进程将 HTML 内容转换为能够读懂的 DOM 树结构。
		# 渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets，计算出 DOM 	节点的样式。
		# 创建布局树，并计算元素的布局信息。
		# 对布局树进行分层，并生成分层树。
		# 为每个图层生成绘制列表，并将其提交到合成线程。
		# 合成线程将图层分成图块，并在光栅化线程池中将图块转换成位图。
		# 合成线程发送绘制图块命令 DrawQuad 给浏览器进程。
		# 浏览器进程根据 DrawQuad 消息生成页面，并显示到显示器上。
	```

### 提交文档
- 将网络进程收到的html数据，交给渲染进程的过程
- 首先当浏览器 进程收到网络进程的响应头，便向浏览器发起“提交文档”
- 渲染进程收到提交文档消息后，会和网络进程建立传输数据通道
- 等文档传输完成，渲染进程会返回“确认提交”的消息给浏览器进程
- 浏览器进程收到“确认消息”，会更新浏览器界面

### 渲染阶段
- 构建 DOM: 将html转换成树形结构
- 样式计算
- 将css文本转换成styleSheets。
- 转换属性值，使标准化
- 计算每个结点的样式
	- 继承
	- 层叠

### 布局阶段
- 计算出 DOM 树中可见元素的几何位置，我们把这个计算过程叫做布局。
- 创建布局树
	- 遍历所有可见节点 ，并把这些节点加到 布局树中
	- 布局计算
- 分层
	- 为特定的节点生成专用的图层，并生成一颗图层树
	- 拥有层叠上下文属性的元素会被提升为单独的一层。
	- 第二点，需要剪裁（clip）的地方也会被创建为图层。
- 绘制
	- 待绘制列表
- 分块
	- 当绘制列表准备好以后，主线程会将它提交给合成线程
	- 合成线程会将图层划分为图块（tile）
- 栅格化
	- 将图块转换为位图
	-  GPU 来加速生成，使用 GPU 生成位图的过程叫快速栅格化，或者 GPU 栅格化，生成的位图被保存在 GPU 内存中。
	- 最终生成位图都是在GPU中完成的 
- 合成
	- 一旦所有图块都被光栅化，合成线程就会生成一个绘制图块的命令——“DrawQuad”，然后将该命令提交给浏览器进程。

### 其他
- 重排
	- 更新了元素的几何属性（重排）
	- 重排需要更新完整的渲染流水线，所以开销也是最大的。
	- width、height、margin、border

- 重绘
	- 更新元素的绘制属性（重绘）
	- 重绘省去了布局和分层阶段，所以执行效率会比重排操作要高一些。
	- color、border-style、background、text-decoration、outline
- 合成 
	- 既不要布局也不要绘制的属性
	- transform


